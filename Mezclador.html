<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéõÔ∏è MEZCLADOR PRO V2</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-console: #1a1a1a;
            --bg-strip: #0f0f0f;
            --accent: #00d2ff;
            --meter-bg: #050505;
        }
        body { 
            background-color: #050505; color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box;
        }
        h1 { color: var(--accent); margin: 0 0 10px 0; font-size: 1.2rem; text-align: center; }

        /* CONTENEDOR PRINCIPAL DE LA CONSOLA */
        #console-container {
            display: flex;
            gap: 10px;
            overflow-x: auto; /* Scroll horizontal si hay muchos canales */
            flex-grow: 1;
            background: var(--bg-console);
            padding: 15px;
            border-radius: 8px;
            border-top: 3px solid var(--accent);
        }

        /* --- CHANNEL STRIP (TIRA DE CANAL VERTICAL) --- */
        .channel-strip {
            background: var(--bg-strip);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 90px;
            flex-shrink: 0; /* Evitar que se aplasten */
        }
        .strip-title { font-size: 0.7rem; font-weight: bold; margin-bottom: 10px; text-align: center; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
        .local-mic-title { color: var(--accent); }
        
        /* √ÅREA CENTRAL: MEDIDOR Y FADER */
        .fader-area {
            display: flex;
            gap: 10px;
            height: 200px; /* Altura de los controles */
            margin-bottom: 15px;
        }

        /* MEDIDOR VERTICAL (V√öMETRO) ESTILO IMAGEN */
        .meter-container {
            width: 18px;
            height: 100%;
            background: var(--meter-bg);
            border: 1px solid #222;
            border-radius: 2px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 5px #000;
        }
        /* El gradiente de fondo (Verde -> Amarillo -> Rojo) */
        .meter-gradient {
            position: absolute; inset: 0;
            background: linear-gradient(to top, 
                #00ff00 0%,   /* Verde abajo */
                #00ff00 50%, 
                #ffff00 75%,  /* Amarillo medio */
                #ff0000 100%  /* Rojo arriba */
            );
            z-index: 1;
        }
        /* La "m√°scara" negra que baja para revelar el color */
        .meter-mask {
            position: absolute; top: 0; left: 0; width: 100%;
            background: var(--meter-bg);
            height: 100%; /* Empieza tapando todo */
            z-index: 2;
            transition: height 0.08s ease-out; /* Suavizado r√°pido */
        }
        /* L√≠neas de escala decorativas */
        .meter-scale {
            position: absolute; inset: 0; z-index: 3; pointer-events: none;
            background: repeating-linear-gradient(to top, transparent 0px, transparent 4px, rgba(0,0,0,0.5) 5px);
        }

        /* FADER VERTICAL (SLIDER) */
        /* Usamos -webkit-appearance para navegadores m√≥viles modernos */
        input[type=range][orient=vertical] {
            writing-mode: bt-lr; /* IE/Edge */
            -webkit-appearance: slider-vertical; /* Webkit (Chrome/Safari) */
            width: 30px;
            height: 100%;
            padding: 0;
            margin: 0;
            cursor: pointer;
            accent-color: var(--accent);
        }

        /* BOTONES Y ESTADOS */
        .btn-mute {
            width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #fff;
            font-size: 0.7rem; font-weight: bold; cursor: pointer; border-radius: 4px;
        }
        .btn-mute.muted { background: #ff0000; border-color: #ff0000; color: #000; }
        
        .status-indicator { font-size: 0.6rem; margin-top: 5px; color: #0f0; }

        /* --- SECCI√ìN MASTER --- */
        .master-strip {
            border: 2px solid var(--accent);
            background: #111;
            margin-left: auto; /* Empujar a la derecha si hay espacio */
        }
        .master-title { color: var(--accent); font-size: 0.9rem; }

        /* --- OVERLAY INICIO --- */
        #overlay { position: fixed; inset: 0; background: #000; z-index: 99; display: flex; justify-content: center; align-items: center; }
        #btn-start { padding: 20px 40px; font-size: 1.5rem; background: var(--accent); border: none; border-radius: 50px; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px var(--accent); }
    </style>
</head>
<body>

    <div id="overlay"><button id="btn-start">ENCENDER CONSOLA üéõÔ∏è</button></div>

    <h1>üéõÔ∏è MEZCLADOR PRO</h1>
    <div style="color: #666; font-size: 0.8rem; text-align: center; margin-bottom: 10px;">ID: obr-mezclador-central</div>

    <div id="console-container">
        <div class="channel-strip master-strip" id="master-channel" style="order: 99;">
            <div class="strip-title master-title">MAIN OUTPUT</div>
            <div class="fader-area">
                <div class="meter-container">
                    <div class="meter-gradient"></div>
                    <div class="meter-scale"></div>
                    <div class="meter-mask" id="mask-master"></div>
                </div>
                <input type="range" orient="vertical" id="master-fader" min="0" max="2" step="0.01" value="1">
            </div>
            <div style="font-size: 0.7rem; color: #aaa;">MASTER GAIN</div>
        </div>
        
        </div>

    <audio id="silence-hack" loop src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeGQAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"></audio>

<script>
    const MY_ID = "obr-mezclador-central";
    let audioCtx, broadcastNode, monitorNode, masterGain, masterAnalyser;
    let peer;
    let mixStreams = new Map(); // Para guardar referencias a los nodos

    document.getElementById('btn-start').addEventListener('click', async () => {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- RUTA MASTER ---
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 1; // Valor inicial del fader master

        masterAnalyser = audioCtx.createAnalyser();
        masterAnalyser.fftSize = 128; // Tama√±o peque√±o para respuesta r√°pida
        masterAnalyser.smoothingTimeConstant = 0.8; // Suavizado del medidor

        broadcastNode = audioCtx.createMediaStreamDestination();
        monitorNode = audioCtx.createGain(); monitorNode.gain.value = 1; monitorNode.connect(audioCtx.destination);

        // Conexiones Master: Mezcla -> Gain Master -> Analizador -> Salidas
        masterGain.connect(masterAnalyser);
        masterGain.connect(broadcastNode);
        // masterGain.connect(monitorNode); // Descomentar si quieres escuchar el master en tus bocinas siempre

        // Iniciar animaci√≥n del medidor Master
        animateMeter(masterAnalyser, 'mask-master');

        // --- PEERJS ---
        peer = new Peer(MY_ID);
        peer.on('call', call => {
            call.answer();
            call.on('stream', stream => addChannelStrip(call.peer, stream));
            call.on('close', () => removeChannelStrip(call.peer));
        });

        // Conexi√≥n de datos del Detector
        peer.on('connection', conn => {
            setTimeout(() => { peer.call(conn.peer, broadcastNode.stream); }, 1000);
            conn.on('data', data => {
                console.log("Comando:", data.cmd);
                monitorNode.gain.value = (data.cmd === 'RX_OFF') ? 1 : 0;
            });
            conn.on('close', () => { monitorNode.gain.value = 1; }); // Si se desconecta, activar monitor
        });

        // --- MICROFONO LOCAL ---
        try {
            const stream = await navigator.mediaDevices.getUserMedia({audio: true, video: false});
            addChannelStrip("LOCAL", stream, true);
        } catch(e) { console.log("Sin mic local"); }

        document.getElementById('silence-hack').play();
        document.getElementById('overlay').style.display = 'none';

        // Fader Master Evento
        document.getElementById('master-fader').addEventListener('input', e => {
            masterGain.gain.value = e.target.value;
        });
    });

    // --- FUNCIONES DE LA INTERFAZ ---

    function addChannelStrip(id, stream, isLocal = false) {
        if(document.getElementById('strip-' + id)) return; // Evitar duplicados

        const consoleContainer = document.getElementById('console-container');
        
        // 1. Crear Nodos de Audio para este canal
        const source = audioCtx.createMediaStreamSource(stream);
        const channelGain = audioCtx.createGain();
        const channelAnalyser = audioCtx.createAnalyser();
        channelAnalyser.fftSize = 128;
        channelAnalyser.smoothingTimeConstant = 0.8;

        // Ruteo: Fuente -> Gain del Canal -> Analizador -> Master Mix
        source.connect(channelGain);
        channelGain.connect(channelAnalyser);
        channelGain.connect(masterGain);

        // Guardar referencias
        mixStreams.set(id, { source, gain: channelGain, analyser: channelAnalyser });

        // 2. Crear HTML del Channel Strip
        const strip = document.createElement('div');
        strip.className = 'channel-strip';
        strip.id = 'strip-' + id;
        // Insertar antes del Master
        strip.style.order = isLocal ? 1 : 10; 

        const titleClass = isLocal ? 'strip-title local-mic-title' : 'strip-title';
        const titleText = isLocal ? 'üéôÔ∏è LOCAL MIC' : `üì± ${id.substring(0,5)}...`;

        strip.innerHTML = `
            <div class="${titleClass}" title="${id}">${titleText}</div>
            <div class="fader-area">
                <div class="meter-container">
                    <div class="meter-gradient"></div>
                    <div class="meter-scale"></div>
                    <div class="meter-mask" id="mask-${id}"></div>
                </div>
                <input type="range" orient="vertical" class="channel-fader" min="0" max="2" step="0.01" value="1">
            </div>
            <button class="btn-mute">MUTE</button>
            ${!isLocal ? '<div class="status-indicator">‚óè LIVE</div>' : ''}
        `;

        consoleContainer.appendChild(strip);

        // 3. Conectar Eventos de la UI
        const fader = strip.querySelector('.channel-fader');
        const muteBtn = strip.querySelector('.btn-mute');
        let isMuted = false;
        let lastVol = 1;

        // Fader (Gain)
        fader.addEventListener('input', e => {
            if(!isMuted) channelGain.gain.value = e.target.value;
        });

        // Mute
        muteBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            if(isMuted) {
                lastVol = fader.value;
                channelGain.gain.value = 0;
                muteBtn.classList.add('muted');
                muteBtn.innerText = "MUTED";
                fader.disabled = true;
            } else {
                fader.value = lastVol;
                channelGain.gain.value = lastVol;
                muteBtn.classList.remove('muted');
                muteBtn.innerText = "MUTE";
                fader.disabled = false;
            }
        });

        // Iniciar animaci√≥n del medidor de este canal
        animateMeter(channelAnalyser, `mask-${id}`);
    }

    function removeChannelStrip(id) {
        const strip = document.getElementById('strip-' + id);
        if(strip) strip.remove();
        if(mixStreams.has(id)) mixStreams.delete(id); // Limpiar referencias
    }

    // --- MOTOR DE ANIMACI√ìN DE LOS MEDIDORES ---
    const dataArray = new Uint8Array(128);

    function animateMeter(analyserNode, maskId) {
        const maskElement = document.getElementById(maskId);
        if(!maskElement || !analyserNode) return;

        function draw() {
             // Si el elemento ya no existe (canal desconectado), parar animaci√≥n
            if(!document.getElementById(maskId)) return;
            requestAnimationFrame(draw);

            analyserNode.getByteFrequencyData(dataArray);

            // Calcular volumen promedio (RMS simple)
            let sum = 0;
            // Usamos solo una parte del espectro para la energ√≠a principal
            for(let i = 0; i < dataArray.length / 2; i++) {
                sum += dataArray[i] * dataArray[i];
            }
            const rms = Math.sqrt(sum / (dataArray.length / 2));
            
            // Convertir a porcentaje de altura (ajustar el divisor 200 para sensibilidad)
            // Cuanto menor sea la m√°scara, m√°s se ve la barra.
            // 100% mascara = silencio. 0% mascara = volumen maximo.
            let maskHeightPercentage = 100 - (rms / 200 * 100);
            maskHeightPercentage = Math.max(0, Math.min(100, maskHeightPercentage)); // Limitar entre 0 y 100

            maskElement.style.height = maskHeightPercentage + "%";
        }
        draw();
    }
</script>
</body>
</html>
