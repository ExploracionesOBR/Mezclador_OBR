<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéõÔ∏è MEZCLADOR OBR (FINAL)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --accent: #00d2ff; --meter-bg: rgba(0,0,0,0.8); }
        
        body { 
            background-image: url('./fondo_pantalla.jpg'); 
            background-position: center; background-repeat: no-repeat; background-size: cover; background-attachment: fixed;
            background-color: #050505; 
            color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box;
        }
        body::before { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: -1; }

        header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid var(--accent); }
        .logo-group { display: flex; align-items: center; gap: 10px; }
        .obr-logo { height: 50px; width: auto; display: block; }
        h1 { color: var(--accent); margin: 0; font-size: 1.2rem; letter-spacing: 1px; }

        /* INDICADORES */
        .status-group { display: flex; gap: 10px; }
        .status-badge { padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: 1px solid #333; background: #111; color: #666; text-transform: uppercase; }
        .monitor-active { background: #00ff41; color: #000; box-shadow: 0 0 10px #00ff41; border-color: #00ff41; }
        .det-disconnected { background: #330000; color: #ff4444; border-color: #ff0000; }
        .det-connected { background: #00d2ff; color: #000; border-color: #00d2ff; box-shadow: 0 0 15px #00d2ff; animation: pulseStatus 2s infinite; }
        @keyframes pulseStatus { 50% { opacity: 0.8; } }

        #console-container { display: flex; gap: 10px; overflow-x: auto; flex-grow: 1; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; backdrop-filter: blur(5px); }
        .channel-strip { background: rgba(20,20,20,0.8); border: 1px solid #333; border-radius: 4px; padding: 10px; display: flex; flex-direction: column; align-items: center; min-width: 90px; flex-shrink: 0; }
        .strip-title { font-size: 0.7rem; font-weight: bold; margin-bottom: 10px; text-align: center; color: #ccc; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
        .local-mic-title { color: var(--accent); }
        .fader-area { display: flex; gap: 10px; height: 180px; margin-bottom: 15px; }
        .meter-container { width: 18px; height: 100%; background: var(--meter-bg); border: 1px solid #555; border-radius: 2px; position: relative; overflow: hidden; }
        .meter-gradient { position: absolute; inset: 0; background: linear-gradient(to top, #00ff00 0%, #00ff00 50%, #ffff00 75%, #ff0000 100%); z-index: 1; }
        .meter-mask { position: absolute; top: 0; left: 0; width: 100%; background: var(--meter-bg); height: 100%; z-index: 2; transition: height 0.08s ease-out; }
        input[type=range][orient=vertical] { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 30px; height: 100%; margin: 0; cursor: pointer; accent-color: var(--accent); }
        .btn-mute { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #fff; font-size: 0.7rem; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .btn-mute.muted { background: #ff0000; border-color: #ff0000; color: #000; }
        .master-strip { border: 2px solid var(--accent); background: rgba(30,30,30,0.9); margin-left: auto; }
        .master-title { color: var(--accent); }
        .btn-qr { background: #333; color: white; border: 1px solid #555; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        #overlay { position: fixed; inset: 0; background: #000; z-index: 99; display: flex; justify-content: center; align-items: center; }
        #btn-start { padding: 20px 40px; font-size: 1.5rem; background: var(--accent); border: none; border-radius: 50px; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 50% { transform: scale(1.05); } }
        #qr-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; flex-direction: column; }
        #qrcode { background: white; padding: 20px; border-radius: 8px; }
        #audio-dump { display: none; }
    </style>
</head>
<body>

    <div id="overlay"><button id="btn-start">INICIAR MEZCLADOR</button></div>

    <div id="qr-modal" onclick="this.style.display='none'">
        <div id="qrcode"></div>
        <p style="margin-top:10px; color:white;">QR PARA MICR√ìFONOS</p>
    </div>

    <header>
        <div class="logo-group">
            <img src="./obr-logo.png" alt="OBR Logo" class="obr-logo" onerror="this.style.display='none'"> 
            <h1>MEZCLADOR CENTRAL</h1>
        </div>
        <div class="status-group">
            <div id="det-status" class="status-badge det-disconnected">DETECTOR: OFF</div>
            <div id="mon-status" class="status-badge">MONITOR: ON</div>
            <button class="btn-qr" onclick="document.getElementById('qr-modal').style.display='flex'">VER QR</button>
        </div>
    </header>

    <div id="console-container">
        <div class="channel-strip master-strip" id="master-channel" style="order: 99;">
            <div class="strip-title master-title">MAIN OUT</div>
            <div class="fader-area">
                <div class="meter-container"><div class="meter-gradient"></div><div class="meter-mask" id="mask-master"></div></div>
                <input type="range" orient="vertical" id="master-fader" min="0" max="2" step="0.01" value="1">
            </div>
        </div>
    </div>
    
    <audio id="silence-hack" loop src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeGQAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"></audio>
    <div id="audio-dump"></div>

<script>
    // CONFIGURACI√ìN DE RED ROBUSTA (IGUAL QUE EN EL MICROFONO)
    const peerConfig = {
        config: {
            iceServers: [
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' },
                // OpenRelay (TURN Gratis para saltar firewall 4G)
                { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
            ],
            sdpSemantics: 'unified-plan'
        }
    };

    const FIXED_ID = "obr-mezclador-central";
    let peer, audioCtx, masterGain, masterAnalyser, monitorNode;

    document.getElementById('btn-start').addEventListener('click', async () => {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        
        // Rutas de Audio
        masterGain = audioCtx.createGain();
        masterAnalyser = audioCtx.createAnalyser(); masterAnalyser.fftSize = 128;
        monitorNode = audioCtx.createGain(); monitorNode.gain.value = 1;
        
        const broadcastNode = audioCtx.createMediaStreamDestination();
        masterGain.connect(masterAnalyser); masterGain.connect(broadcastNode); masterGain.connect(monitorNode); monitorNode.connect(audioCtx.destination);
        animateMeter(masterAnalyser, 'mask-master');

        // INICIAR PEER CON CONFIGURACI√ìN DE RED
        peer = new Peer(FIXED_ID, peerConfig);
        
        peer.on('open', id => {
            console.log("Mezclador Online:", id);
            new QRCode(document.getElementById("qrcode"), { text: id, width: 200, height: 200 });
        });
        
        peer.on('error', err => { 
            if(err.type === 'unavailable-id') {
                alert("‚ö†Ô∏è ERROR DE SESI√ìN DUPLICADA\n\nYa tienes el Mezclador abierto en otro dispositivo (quiz√°s la PC).\n\nCierra la otra pesta√±a para usar este dispositivo como base.");
            } else {
                console.error(err);
            }
        });
        
        peer.on('call', call => { 
            call.answer(); 
            call.on('stream', stream => addChannelStrip(call.peer, stream)); 
            call.on('close', () => removeChannelStrip(call.peer)); 
        });
        
        peer.on('connection', conn => {
            updateDetectorStatus(true);
            setTimeout(() => peer.call(conn.peer, broadcastNode.stream), 1000);
            conn.on('data', data => { monitorNode.gain.value = (data.cmd === 'RX_ON') ? 0 : 1; updateMonUI(data.cmd !== 'RX_ON'); });
            conn.on('close', () => { monitorNode.gain.value = 1; updateMonUI(true); updateDetectorStatus(false); });
        });

        try { const s = await navigator.mediaDevices.getUserMedia({audio: true}); addChannelStrip("LOCAL", s, true); } catch(e){}
        document.getElementById('silence-hack').play();
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('master-fader').addEventListener('input', e => masterGain.gain.value = e.target.value);
        
        if (audioCtx.state === 'suspended') audioCtx.resume();
    });

    function updateDetectorStatus(isConnected) {
        const el = document.getElementById('det-status');
        if(isConnected) { el.innerText = "DETECTOR: ONLINE"; el.className = "status-badge det-connected"; } 
        else { el.innerText = "DETECTOR: OFF"; el.className = "status-badge det-disconnected"; }
    }

    function updateMonUI(isActive) {
        const el = document.getElementById('mon-status');
        if(isActive) { el.innerText = "MONITOR: ON"; el.classList.add('monitor-active'); }
        else { el.innerText = "MONITOR: OFF"; el.classList.remove('monitor-active'); }
    }

    function addChannelStrip(id, stream, isLocal = false) {
        if(document.getElementById('strip-' + id)) return;
        
        // HACK AUDIO GHOST (CRUCIAL PARA M√ìVILES)
        const audioGhost = document.createElement('audio');
        audioGhost.id = 'ghost-' + id;
        audioGhost.srcObject = stream;
        audioGhost.autoplay = true;
        audioGhost.muted = true; 
        audioGhost.playsInline = true;
        document.getElementById('audio-dump').appendChild(audioGhost);
        audioGhost.play().catch(e => {});
        
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const container = document.getElementById('console-container');
        const source = audioCtx.createMediaStreamSource(stream);
        const gain = audioCtx.createGain(); const anal = audioCtx.createAnalyser(); anal.fftSize = 128;
        source.connect(gain); gain.connect(anal); gain.connect(masterGain);

        const div = document.createElement('div'); div.className = 'channel-strip'; div.id = 'strip-' + id; div.style.order = isLocal?1:10;
        const name = isLocal ? "üéôÔ∏è LOCAL" : `üì± ${id.replace('obr-mic-','').substring(0,4)}`;
        div.innerHTML = `<div class="strip-title ${isLocal?'local-mic-title':''}">${name}</div><div class="fader-area"><div class="meter-container"><div class="meter-gradient"></div><div class="meter-mask" id="mask-${id}"></div></div><input type="range" orient="vertical" class="ch-fader" min="0" max="2" step="0.01" value="1"></div><button class="btn-mute">MUTE</button>`;
        container.appendChild(div);

        const fader = div.querySelector('.ch-fader'); const mute = div.querySelector('.btn-mute'); let isMuted = false, prevVol = 1;
        fader.addEventListener('input', e => { if(!isMuted) gain.gain.value = e.target.value; });
        mute.addEventListener('click', () => { isMuted = !isMuted; if(isMuted){ prevVol=fader.value; gain.gain.value=0; mute.classList.add('muted'); fader.disabled=true; } else { gain.gain.value=prevVol; fader.value=prevVol; mute.classList.remove('muted'); fader.disabled=false; } });
        animateMeter(anal, `mask-${id}`);
    }

    function removeChannelStrip(id) { 
        const el = document.getElementById('strip-' + id); if(el) el.remove(); 
        const ghost = document.getElementById('ghost-' + id); if(ghost) ghost.remove();
    }
    
    const dArray = new Uint8Array(128);
    function animateMeter(analyser, maskId) {
        const mask = document.getElementById(maskId); if(!mask) return;
        function loop() { if(!document.getElementById(maskId)) return; requestAnimationFrame(loop); analyser.getByteFrequencyData(dArray); let sum=0; for(let i=0; i<dArray.length/2; i++) sum+=dArray[i]*dArray[i]; const rms = Math.sqrt(sum/(dArray.length/2)); let h = 100-(rms/200*100); mask.style.height = Math.max(0, Math.min(100, h))+"%"; } loop();
    }
</script>
</body>
</html>
