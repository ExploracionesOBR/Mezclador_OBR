<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéõÔ∏è Mezclador M√≥vil</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* ESTILO M√ìVIL (T√ÅCTIL) */
        body { 
            background-color: #121212; 
            color: #fff; 
            font-family: system-ui, sans-serif; 
            margin: 0; 
            padding: 10px;
            padding-bottom: 50px; /* Espacio para scroll */
        }
        
        h1 { font-size: 1.2rem; text-align: center; margin: 10px 0; color: #00d2ff; }

        /* Paneles de Configuraci√≥n (Colapsables visualmente) */
        .config-box {
            background: #222;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }

        .id-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00d2ff;
            text-align: center;
            letter-spacing: 1px;
            margin: 5px 0;
            word-break: break-all;
        }

        /* Inputs y Botones Grandes */
        input[type="text"] {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            background: #333;
            border: none;
            color: white;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
            text-align: center;
        }

        button.btn-main {
            width: 100%;
            padding: 12px;
            background: #0f0;
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
        }

        /* CANALES DE AUDIO (Tarjetas Verticales) */
        .channel-card {
            background: #1e1e1e;
            border-left: 6px solid #00d2ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .channel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-id { font-weight: bold; font-size: 1.1rem; }
        .status-badge { background: #004400; color: #0f0; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }

        /* Sliders gordos para dedos */
        .slider-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; color: #aaa; margin-bottom: 5px; }
        
        input[type=range] {
            width: 100%;
            height: 30px; /* M√°s alto para tocar f√°cil */
            accent-color: #00d2ff;
            cursor: pointer;
        }

        .btn-mute {
            width: 100%;
            padding: 15px;
            background: #333;
            border: 2px solid #555;
            color: white;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .btn-mute.muted { background: #ff4444; border-color: #ff0000; color: white; }

        /* Audio invisible para mantener activo el celular */
        audio { display: none; }
    </style>
</head>
<body>

    <h1>üéõÔ∏è MEZCLADOR M√ìVIL</h1>

    <div class="config-box">
        <div style="font-size: 0.8rem; color: #888; text-align: center;">MI ID (Compartir al equipo):</div>
        <div class="id-display" id="my-id">Generando...</div>
    </div>

    <div class="config-box" style="border-color: #004400;">
        <div style="font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 5px;">CONECTAR A SALIDA FINAL:</div>
        <input type="text" id="listener-id" placeholder="Pegar ID del Oyente aqu√≠">
        <button class="btn-main" onclick="connectToMaster()">ENLAZAR SALIDA üì°</button>
    </div>

    <h3 style="margin-left: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;">CANALES ACTIVOS</h3>
    <div id="channels-container">
        <p style="text-align: center; color: #555; margin-top: 30px;">Esperando conexiones...</p>
    </div>

    <audio id="keep-alive" loop>
         <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeGQAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mpeg">
    </audio>

<script>
    const peer = new Peer(null);
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterDestination = audioCtx.createMediaStreamDestination();
    
    // Wake Lock para que el celular no se duerma
    let wakeLock = null;
    async function requestWakeLock() {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            document.getElementById('keep-alive').play().catch(e=>{});
        } catch (err) { console.log(err); }
    }
    document.body.addEventListener('click', requestWakeLock, {once:true});

    // 1. OBTENER MI ID
    peer.on('open', id => {
        document.getElementById('my-id').innerText = id;
    });

    // 2. RECIBIR LLAMADAS (MICR√ìFONOS)
    peer.on('call', call => {
        call.answer();
        call.on('stream', remoteStream => {
            addMobileChannel(call.peer, remoteStream);
        });
    });

    // 3. CONECTAR SALIDA MASTER
    function connectToMaster() {
        const listenerId = document.getElementById('listener-id').value;
        if(!listenerId) return alert("Falta el ID de salida");
        peer.call(listenerId, masterDestination.stream);
        alert("¬°Enlazado a la salida!");
    }

    // 4. CREAR INTERFAZ T√ÅCTIL PARA CADA CANAL
    function addMobileChannel(peerId, stream) {
        const container = document.getElementById('channels-container');
        if(container.querySelector('p')) container.innerHTML = '';

        // Audio Logic
        const source = audioCtx.createMediaStreamSource(stream);
        const gainNode = audioCtx.createGain();
        
        source.connect(gainNode);
        gainNode.connect(audioCtx.destination); // O√≠r en el celular mezclador
        gainNode.connect(masterDestination);    // Enviar a la salida final

        // UI Logic
        const card = document.createElement('div');
        card.className = 'channel-card';
        card.innerHTML = `
            <div class="channel-header">
                <span class="user-id">üì± ${peerId.substring(0,5)}</span>
                <span class="status-badge">EN VIVO</span>
            </div>
            
            <div class="slider-group">
                <label>VOLUMEN</label>
                <input type="range" min="0" max="2" step="0.1" value="1" class="vol-slider">
            </div>

            <button class="btn-mute">MUTE</button>
        `;

        // Eventos
        const slider = card.querySelector('.vol-slider');
        const muteBtn = card.querySelector('.btn-mute');
        let lastVol = 1;

        slider.addEventListener('input', (e) => {
            gainNode.gain.value = e.target.value;
            if(gainNode.gain.value > 0) {
                muteBtn.classList.remove('muted');
                muteBtn.innerText = "MUTE";
            }
        });

        muteBtn.addEventListener('click', () => {
            if(gainNode.gain.value > 0) {
                lastVol = slider.value;
                gainNode.gain.value = 0;
                slider.value = 0;
                muteBtn.classList.add('muted');
                muteBtn.innerText = "DESMUTEAR";
            } else {
                gainNode.gain.value = lastVol;
                slider.value = lastVol;
                muteBtn.classList.remove('muted');
                muteBtn.innerText = "MUTE";
            }
        });

        container.appendChild(card);
    }
</script>
</body>
</html>
