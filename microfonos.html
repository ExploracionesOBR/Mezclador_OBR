<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéôÔ∏è MICRO OBR (EXTERNO)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root { --accent: #00d2ff; --danger: #ff0000; }
        body { 
            background-image: url('./fondo_pantalla.jpg');
            background-position: center; background-size: cover; background-repeat: no-repeat; background-color: #000;
            color: #ffffff; font-family: system-ui, -apple-system, sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box;
        }
        body::before { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: -1; }

        .logo-header { margin-bottom: 20px; text-align: center; }
        .obr-logo { width: 80px; height: auto; margin-bottom: 10px; filter: drop-shadow(0 0 10px var(--accent)); display: block; margin: 0 auto; }
        h1 { margin: 0; color: var(--accent); font-size: 1.5rem; letter-spacing: 2px; }

        .main-card {
            background: rgba(0,0,0,0.8); border: 1px solid #333; border-radius: 15px;
            padding: 20px; width: 100%; max-width: 400px; text-align: center;
            backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* SELECTOR DE MICROFONO MEJORADO */
        .mic-selector-container { margin-bottom: 15px; text-align: left; border-bottom: 1px solid #444; padding-bottom: 15px; }
        .mic-label { font-size: 0.7rem; color: var(--accent); margin-bottom: 5px; display: block; font-weight: bold; letter-spacing: 1px; }
        #mic-select {
            width: 100%; padding: 12px; background: #111; border: 1px solid #555; 
            color: white; border-radius: 8px; font-size: 0.9rem; outline: none;
        }
        #mic-select:focus { border-color: var(--accent); }

        #qr-reader { width: 100%; margin-bottom: 15px; border-radius: 8px; overflow: hidden; display: none; background: #000; }
        
        #btn-action {
            width: 100%; padding: 15px; font-size: 1.1rem; font-weight: bold;
            border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s;
            background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0, 210, 255, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        #btn-action.live { background: var(--danger); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }

        #manual-input-area { display: none; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; }
        .input-id { width: 70%; padding: 10px; background: #222; border: 1px solid #555; color: white; border-radius: 5px; text-align: center; text-transform: uppercase; }
        .btn-go { width: 25%; padding: 10px; background: #333; border: 1px solid #fff; color: white; border-radius: 5px; cursor: pointer; }

        #status { margin-top: 15px; font-size: 0.9rem; color: #aaa; font-family: monospace; word-break: break-word; }
        
        /* MEDIDOR DE NIVEL SIMPLE (Para verificar que entra audio) */
        #audio-meter { width: 100%; height: 5px; background: #333; margin-top: 10px; border-radius: 5px; overflow: hidden; }
        #audio-level { width: 0%; height: 100%; background: var(--accent); transition: width 0.1s; }
        
        audio { display: none; }
    </style>
</head>
<body>

    <div class="logo-header">
        <img src="./obr-logo.png" alt="OBR Logo" class="obr-logo" onerror="this.style.display='none'">
        <h1>MICROFONO OBR</h1>
    </div>

    <div class="main-card">
        
        <div class="mic-selector-container">
            <label class="mic-label">üé§ DISPOSITIVO DE ENTRADA:</label>
            <select id="mic-select">
                <option value="">Detectando hardware...</option>
            </select>
            <div id="audio-meter"><div id="audio-level"></div></div>
        </div>

        <div id="qr-reader"></div>

        <button id="btn-action">
            <span>üì∑</span> <span id="btn-text">ESCANEAR QR</span>
        </button>

        <div id="manual-input-area">
            <p style="color:#ff4444; font-size:0.8rem; margin-bottom:5px;">‚ö†Ô∏è INGRESO MANUAL</p>
            <input type="text" id="input-id" class="input-id" placeholder="ID DEL MEZCLADOR">
            <button class="btn-go" onclick="manualConnect()">IR</button>
        </div>
        
        <div id="status">Conecta tu micr√≥fono externo</div>
    </div>

    <audio id="fake-audio" loop playsinline src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeGQAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"></audio>

<script>
    const btn = document.getElementById('btn-action');
    const btnText = document.getElementById('btn-text');
    const status = document.getElementById('status');
    const qrContainer = document.getElementById('qr-reader');
    const fakeAudio = document.getElementById('fake-audio');
    const manualArea = document.getElementById('manual-input-area');
    const micSelect = document.getElementById('mic-select');
    const audioLevel = document.getElementById('audio-level');
    
    let peer = null;
    let currentCall = null;
    let html5QrCode = null;
    let isScanning = false;
    let isConnected = false;
    let audioContext, analyser, microphone, javascriptNode;

    // 1. INICIALIZAR PEER
    const myMicId = "obr-mic-" + Math.floor(Math.random() * 9999);
    peer = new Peer(myMicId);
    
    peer.on('open', id => { console.log("Mi ID:", id); });
    peer.on('error', err => { status.innerText = "Error Peer: " + err.type; });

    // Escuchar cambios de hardware (conectar/desconectar jack)
    navigator.mediaDevices.ondevicechange = () => {
        status.innerText = "Cambio de hardware detectado...";
        getAudioInputs();
    };

    // 2. OBTENER MICR√ìFONOS Y AUTO-SELECCIONAR EXTERNO
    getAudioInputs();

    async function getAudioInputs() {
        try {
            // Pedir permiso inicial
            await navigator.mediaDevices.getUserMedia({ audio: true });
            const devices = await navigator.mediaDevices.enumerateDevices();
            const audioDevices = devices.filter(device => device.kind === 'audioinput');
            
            micSelect.innerHTML = '';
            
            if (audioDevices.length === 0) {
                micSelect.innerHTML = '<option>No se detectaron micr√≥fonos</option>';
                return;
            }

            audioDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                // Limpiar nombres para que sean m√°s legibles
                let label = device.label || `Micr√≥fono ${micSelect.length + 1}`;
                if(label.includes("Headset") || label.includes("Wired")) label = "üéß MICR√ìFONO EXTERNO";
                else if(label.includes("Default")) label = "Predeterminado (Sistema)";
                
                option.text = label;
                micSelect.appendChild(option);
            });

            // L√ìGICA INTELIGENTE:
            // Si hay m√°s de 1 micr√≥fono, suele significar que el √∫ltimo es el externo conectado.
            // Lo seleccionamos autom√°ticamente.
            if (audioDevices.length > 1) {
                micSelect.selectedIndex = audioDevices.length - 1;
                status.innerText = "Micro Externo seleccionado auto.";
            }

        } catch (err) {
            console.error(err);
            micSelect.innerHTML = '<option>Error: Permiso denegado</option>';
        }
    }

    // 3. BOT√ìN ACCI√ìN
    btn.addEventListener('click', () => {
        if(isConnected) { stopTransmission(); return; }
        if (!isScanning) { startQRScanner(); } else { stopQRScanner(); }
    });

    function startQRScanner() {
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("Error de seguridad (SSL) o Hardware."); showManualInput(); return;
        }
        isScanning = true;
        qrContainer.style.display = "block";
        btnText.innerText = "CANCELAR";
        status.innerText = "Iniciando c√°mara...";

        html5QrCode = new Html5Qrcode("qr-reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
        
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
        .catch(err => {
            status.innerText = "‚õî C√°mara bloqueada."; stopQRScanner(); showManualInput();
        });
    }

    function stopQRScanner() {
        isScanning = false;
        if(html5QrCode) {
            html5QrCode.stop().then(() => { qrContainer.style.display = "none"; html5QrCode.clear(); }).catch(e=>{ qrContainer.style.display = "none"; });
        }
        if(!isConnected) { btnText.innerText = "ESCANEAR QR"; status.innerText = "Listo."; }
    }

    function showManualInput() { manualArea.style.display = "block"; }
    function manualConnect() { const id = document.getElementById('input-id').value.trim(); if(id.length > 0) connectToMixer(id); }
    function onScanSuccess(decodedText) { stopQRScanner(); connectToMixer(decodedText); }
    function onScanFailure(error) {}

    // 4. CONEXI√ìN Y PROCESAMIENTO "AUDIO PURO"
    async function connectToMixer(mixerId) {
        const selectedMicId = micSelect.value;
        status.innerText = "Estableciendo audio puro...";
        
        try {
            // CONFIGURACI√ìN CR√çTICA PARA MICRO EXTERNO
            const constraints = {
                audio: {
                    deviceId: selectedMicId ? { exact: selectedMicId } : undefined,
                    // APAGAR TODO EL PROCESAMIENTO PARA QUE EL MOVIL NO USE EL MICRO INTERNO PARA CANCELAR RUIDO
                    echoCancellation: false, 
                    noiseSuppression: false,
                    autoGainControl: false,
                    googEchoCancellation: false,
                    googAutoGainControl: false,
                    googNoiseSuppression: false,
                    googHighpassFilter: false
                },
                video: false
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);

            // Iniciar medidor visual local
            startLocalMeter(stream);

            fakeAudio.play().catch(e => {});
            if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(e=>{});

            const call = peer.call(mixerId, stream);
            currentCall = call;

            isConnected = true;
            btn.classList.add('live');
            btn.innerHTML = "üõë DETENER (EN VIVO)";
            status.innerText = "TRANSMITIENDO: " + (micSelect.options[micSelect.selectedIndex]?.text);
            status.style.color = "#00ff00";
            manualArea.style.display = "none";
            micSelect.disabled = true;

            call.on('close', stopTransmission);
            call.on('error', stopTransmission);

        } catch (err) {
            alert("Error micro: " + err.message);
            stopTransmission();
        }
    }

    function startLocalMeter(stream) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

        analyser.smoothingTimeConstant = 0.8;
        analyser.fftSize = 1024;

        microphone.connect(analyser);
        analyser.connect(javascriptNode);
        javascriptNode.connect(audioContext.destination);

        javascriptNode.onaudioprocess = function() {
            var array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(array);
            var values = 0;
            var length = array.length;
            for (var i = 0; i < length; i++) values += array[i];
            var average = values / length;
            
            // Visualizar nivel
            audioLevel.style.width = (average * 2) + "%"; 
        }
    }

    function stopTransmission() {
        if (currentCall) currentCall.close();
        fakeAudio.pause();
        if(audioContext) audioContext.close();
        
        isConnected = false;
        isScanning = false;
        btn.classList.remove('live');
        btn.innerHTML = "<span>üì∑</span> <span id='btn-text'>ESCANEAR QR</span>";
        status.innerText = "Desconectado";
        status.style.color = "#aaa";
        micSelect.disabled = false;
        audioLevel.style.width = "0%";
    }
</script>
</body>
</html>
