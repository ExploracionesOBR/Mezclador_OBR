<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéôÔ∏è MICRO OBR V3 (FIX RED)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root { --accent: #00d2ff; --danger: #ff0000; --success: #00ff41; }
        body { 
            background-image: url('./fondo_pantalla.jpg');
            background-position: center; background-size: cover; background-color: #000;
            color: #ffffff; font-family: system-ui, -apple-system, sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 15px; box-sizing: border-box;
        }
        body::before { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: -1; }

        .logo-header { margin-bottom: 15px; text-align: center; }
        .obr-logo { width: 60px; height: auto; margin-bottom: 5px; filter: drop-shadow(0 0 10px var(--accent)); display: block; margin: 0 auto; }
        h1 { margin: 0; color: var(--accent); font-size: 1.2rem; letter-spacing: 2px; }

        /* PANEL DE PRUEBA DE MICRO */
        .test-panel {
            background: #1a1a1a; border: 1px solid #444; border-radius: 12px;
            padding: 15px; width: 100%; max-width: 400px; margin-bottom: 20px;
        }
        .label-fix { font-size: 0.7rem; color: #aaa; display: block; margin-bottom: 5px; text-transform: uppercase; }
        
        select {
            width: 100%; padding: 10px; background: #000; border: 1px solid var(--accent); 
            color: #fff; border-radius: 6px; font-size: 0.9rem; outline: none; margin-bottom: 10px;
        }

        /* VUMETRO DE PRUEBA */
        .vu-container { 
            width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; border: 1px solid #555;
            position: relative;
        }
        .vu-bar { 
            width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--success), var(--danger)); 
            transition: width 0.05s ease-out; 
        }
        .vu-text { font-size: 0.7rem; color: #888; text-align: right; margin-top: 3px; }

        /* ESCANER Y BOTONES */
        #qr-reader { width: 100%; border-radius: 8px; overflow: hidden; display: none; background: #000; margin-bottom: 15px; }
        
        .btn-main {
            width: 100%; padding: 18px; font-size: 1.1rem; font-weight: bold;
            border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s;
            background: var(--accent); color: #000; box-shadow: 0 0 20px rgba(0, 210, 255, 0.2);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-main.live { 
            background: var(--danger); color: white; 
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.6); 
            animation: pulse 1.5s infinite; 
        }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        #status { margin-top: 15px; font-size: 0.8rem; color: #666; font-family: monospace; text-align: center; }
        
        /* INPUT MANUAL */
        #manual-area { display: none; width: 100%; max-width: 400px; display: flex; gap: 5px; margin-top: 10px; }
        .input-code { flex: 1; padding: 10px; background: #222; border: 1px solid #555; color: #fff; border-radius: 5px; text-align: center; }
        .btn-go { width: 50px; background: #333; color: #fff; border: 1px solid #fff; border-radius: 5px; }

        audio { display: none; }
    </style>
</head>
<body>

    <div class="logo-header">
        <img src="./obr-logo.png" alt="OBR Logo" class="obr-logo" onerror="this.style.display='none'">
        <h1>MICROFONO EXT</h1>
    </div>

    <div class="test-panel">
        <span class="label-fix">1. SELECCIONA FUENTE DE AUDIO:</span>
        <select id="mic-select" onchange="startAudioStream()"></select>
        
        <div class="vu-container">
            <div id="vu-bar" class="vu-bar"></div>
        </div>
        <div class="vu-text">Prueba golpeando el micro externo</div>
    </div>

    <div id="qr-reader"></div>

    <div style="width: 100%; max-width: 400px;">
        <button id="btn-action" class="btn-main">
            <span>üì°</span> <span id="btn-text">ESCANEAR ENLACE</span>
        </button>

        <div id="manual-area" style="display:none;">
            <input type="text" id="manual-id" class="input-code" placeholder="O escribe ID aqu√≠">
            <button class="btn-go" onclick="manualConnect()">IR</button>
        </div>
    </div>

    <div id="status">Esperando configuraci√≥n...</div>

    <audio id="fake-audio" loop playsinline src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeGQAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"></audio>

<script>
    // CONFIGURACI√ìN DE RED (STUN SERVERS PARA 4G)
    const peerConfig = {
        config: {
            iceServers: [
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ]
        }
    };

    const btn = document.getElementById('btn-action');
    const btnText = document.getElementById('btn-text');
    const status = document.getElementById('status');
    const micSelect = document.getElementById('mic-select');
    const vuBar = document.getElementById('vu-bar');
    const qrContainer = document.getElementById('qr-reader');
    
    let peer, activeStream, audioContext, analyser, microphone, jsNode;
    let currentCall, html5QrCode;
    let isScanning = false, isConnected = false;

    // --- INICIO ---
    // Generar ID y Configurar Peer con servidores STUN
    const myId = "obr-mic-" + Math.floor(Math.random()*10000);
    peer = new Peer(myId, peerConfig);
    
    peer.on('open', id => status.innerText = "Listo. ID Local: " + id);
    peer.on('error', err => { status.innerText = "Error Red: " + err.type; alert("Error de conexi√≥n: " + err.type); });

    // Cargar lista de micros al iniciar
    initAudioSystem();

    async function initAudioSystem() {
        try {
            // Pedir permiso para leer etiquetas
            await navigator.mediaDevices.getUserMedia({ audio: true });
            const devices = await navigator.mediaDevices.enumerateDevices();
            const audioInputs = devices.filter(d => d.kind === 'audioinput');
            
            micSelect.innerHTML = '';
            audioInputs.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                // Intentar identificar externos
                let name = d.label || "Microfono Generico";
                if(name.toLowerCase().includes('headset') || name.toLowerCase().includes('wired')) {
                    name = "üéß " + name.toUpperCase() + " (RECOMENDADO)";
                }
                opt.text = name;
                micSelect.appendChild(opt);
            });

            // Seleccionar el √∫ltimo (usualmente el externo)
            if(audioInputs.length > 1) micSelect.selectedIndex = audioInputs.length - 1;
            
            // INICIAR AUDIO INMEDIATAMENTE PARA PROBAR
            startAudioStream();

        } catch (e) {
            status.innerText = "Error permisos micro: " + e;
        }
    }

    async function startAudioStream() {
        // Detener stream anterior si existe
        if(activeStream) activeStream.getTracks().forEach(t => t.stop());
        
        const deviceId = micSelect.value;
        try {
            // CONFIGURACI√ìN "RAW" PARA EVITAR PROCESAMIENTO DEL CELULAR
            activeStream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    deviceId: { exact: deviceId },
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false,
                    channelCount: 1
                }
            });

            // Activar visualizador (V√∫metro)
            startVisualizer(activeStream);
            status.innerText = "Micro activo. Golpea para probar nivel.";

        } catch (e) {
            alert("No se pudo abrir ese micr√≥fono. Intenta otro.");
        }
    }

    function startVisualizer(stream) {
        if(audioContext) audioContext.close();
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        jsNode = audioContext.createScriptProcessor(2048, 1, 1);

        analyser.smoothingTimeConstant = 0.3;
        analyser.fftSize = 1024;

        microphone.connect(analyser);
        analyser.connect(jsNode);
        jsNode.connect(audioContext.destination);

        jsNode.onaudioprocess = () => {
            const array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(array);
            let values = 0;
            for (let i = 0; i < array.length; i++) values += array[i];
            const average = values / array.length;
            // Mover barra
            vuBar.style.width = Math.min(100, average * 2.5) + "%";
        };
    }

    // --- LOGICA DE CONEXION ---
    
    btn.addEventListener('click', () => {
        if(isConnected) disconnect();
        else if(isScanning) stopScanner();
        else startScanner();
    });

    function startScanner() {
        isScanning = true;
        qrContainer.style.display = 'block';
        btnText.innerText = "CANCELAR";
        
        html5QrCode = new Html5Qrcode("qr-reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decodedText) => { stopScanner(); connectToMixer(decodedText); },
            (err) => {}
        ).catch(err => {
            alert("C√°mara no disponible. Usa el ID manual.");
            stopScanner();
            document.getElementById('manual-area').style.display = 'flex';
        });
    }

    function stopScanner() {
        isScanning = false;
        if(html5QrCode) html5QrCode.stop().then(() => { 
            qrContainer.style.display = 'none'; html5QrCode.clear(); 
        }).catch(e=>{ qrContainer.style.display = 'none'; });
        btnText.innerText = "ESCANEAR ENLACE";
    }

    function manualConnect() {
        const id = document.getElementById('manual-id').value.trim();
        if(id) connectToMixer(id);
    }

    function connectToMixer(mixerId) {
        status.innerText = "Conectando con Base... (Puede tardar en 4G)";
        status.style.color = "yellow";

        // Trucos para mantener vivo en segundo plano
        document.getElementById('fake-audio').play().catch(e=>{});
        if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(e=>{});

        // LLAMADA REAL
        if(!activeStream) { alert("Error: No hay audio seleccionado"); return; }
        
        currentCall = peer.call(mixerId, activeStream);
        
        // Eventos de llamada
        currentCall.on('open', () => {
            // Aunque 'open' no siempre dispara en solo-audio, lo simulamos
        });
        
        // PeerJS a veces no dispara 'open' r√°pido en audio, asumimos √©xito visual
        setConnectedState(true);
        
        currentCall.on('close', () => disconnect());
        currentCall.on('error', (e) => { alert("Error llamada: "+e); disconnect(); });
    }

    function setConnectedState(connected) {
        isConnected = connected;
        if(connected) {
            btn.classList.add('live');
            btn.innerHTML = "üõë DETENER TRANSMISI√ìN";
            status.innerText = "üî¥ EN AIRE - CONECTADO A BASE";
            status.style.color = "#ff0000";
            micSelect.disabled = true;
            document.getElementById('manual-area').style.display = 'none';
        } else {
            btn.classList.remove('live');
            btn.innerHTML = "<span>üì°</span> <span id='btn-text'>ESCANEAR ENLACE</span>";
            status.innerText = "Desconectado";
            status.style.color = "#aaa";
            micSelect.disabled = false;
        }
    }

    function disconnect() {
        if(currentCall) currentCall.close();
        setConnectedState(false);
    }

</script>
</body>
</html>
