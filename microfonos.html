<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéôÔ∏è MICRO OBR (CAM MODE)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root { --accent: #00d2ff; --danger: #ff0000; --success: #00ff41; }
        body { 
            background-image: url('./fondo_pantalla.jpg');
            background-position: center; background-size: cover; background-color: #000;
            color: #ffffff; font-family: system-ui, -apple-system, sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 15px; box-sizing: border-box;
        }
        body::before { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: -1; }

        .logo-header { margin-bottom: 10px; text-align: center; }
        .obr-logo { width: 50px; height: auto; display: block; margin: 0 auto 5px auto; filter: drop-shadow(0 0 10px var(--accent)); }
        h1 { margin: 0; color: var(--accent); font-size: 1.2rem; letter-spacing: 2px; }

        /* PANEL HARDWARE */
        .hw-panel {
            background: #151515; border: 1px solid #444; border-radius: 12px;
            padding: 15px; width: 100%; max-width: 400px; margin-bottom: 20px;
            text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* MODO INDICATOR */
        .mode-badge {
            background: #004400; border: 1px solid #00ff41; color: #00ff41;
            padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold;
            display: inline-block; margin-bottom: 10px;
        }

        /* VUMETRO */
        .vu-container { width: 100%; height: 20px; background: #222; border-radius: 4px; overflow: hidden; border: 1px solid #555; margin: 10px 0; }
        .vu-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--success), var(--danger)); transition: width 0.05s linear; }

        .btn-row { display: flex; gap: 10px; justify-content: center; }
        .btn-small { background: #333; color: #fff; border: 1px solid #666; padding: 8px 15px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; }

        /* ESCANER */
        #qr-reader { width: 100%; border-radius: 8px; overflow: hidden; display: none; background: #000; margin-bottom: 15px; }
        
        .btn-main {
            width: 100%; padding: 18px; font-size: 1.1rem; font-weight: bold;
            border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s;
            background: var(--accent); color: #000; box-shadow: 0 0 20px rgba(0, 210, 255, 0.2);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-main.live { background: var(--danger); color: white; box-shadow: 0 0 30px rgba(255, 0, 0, 0.6); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        #status { margin-top: 15px; font-size: 0.8rem; color: #666; font-family: monospace; text-align: center; }
        #manual-area { display: none; width: 100%; max-width: 400px; gap: 5px; margin-top: 10px; }
        .input-code { flex: 1; padding: 10px; background: #222; border: 1px solid #555; color: #fff; border-radius: 5px; text-align: center; }
        .btn-go { width: 50px; background: #333; color: #fff; border: 1px solid #fff; border-radius: 5px; }

        /* VIDEO OCULTO (El truco) */
        #dummy-video { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        audio { display: none; }
    </style>
</head>
<body>

    <div class="logo-header">
        <img src="./obr-logo.png" alt="OBR Logo" class="obr-logo" onerror="this.style.display='none'">
        <h1>MICROFONO OBR</h1>
    </div>

    <video id="dummy-video" autoplay playsinline muted></video>

    <div class="hw-panel">
        <div class="mode-badge">MODO: GRABACI√ìN VIDEO (FORZADO)</div>
        
        <div class="vu-container"><div id="vu-bar" class="vu-bar"></div></div>
        <div style="font-size:0.65rem; color:#888; margin-bottom:10px;">
            Golpea el micro externo. Si la barra se mueve, est√° listo.
        </div>

        <div class="btn-row">
            <button class="btn-small" onclick="initCamcorderMode()">üîÑ REINICIAR DRIVER</button>
            <button class="btn-small" onclick="toggleMonitor()">üéß MONITOR</button>
        </div>
    </div>

    <div id="qr-reader"></div>

    <div style="width: 100%; max-width: 400px;">
        <button id="btn-action" class="btn-main">
            <span>üì°</span> <span id="btn-text">ESCANEAR ENLACE</span>
        </button>

        <div id="manual-area">
            <input type="text" id="manual-id" class="input-code" placeholder="ID MANUAL">
            <button class="btn-go" onclick="manualConnect()">IR</button>
        </div>
    </div>

    <div id="status">Cargando modo video...</div>
    <audio id="fake-audio" loop playsinline src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeGQAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"></audio>

<script>
    // RED: TURN SERVERS
    const peerConfig = {
        config: {
            iceServers: [
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
            ],
            sdpSemantics: 'unified-plan'
        }
    };

    const btn = document.getElementById('btn-action');
    const btnText = document.getElementById('btn-text');
    const status = document.getElementById('status');
    const vuBar = document.getElementById('vu-bar');
    const qrContainer = document.getElementById('qr-reader');
    const dummyVideo = document.getElementById('dummy-video');
    
    let peer, globalStream, audioContext, analyser, microphone, jsNode, monitorNode;
    let currentCall, html5QrCode;
    let isScanning = false, isConnected = false, isMonitoring = false;

    // --- INICIO ---
    const myId = "obr-mic-" + Math.floor(Math.random()*10000);
    peer = new Peer(myId, peerConfig);
    
    peer.on('open', id => console.log("ID:", id));
    peer.on('error', err => { status.innerText = "Error Red: " + err.type; });

    // INICIAR EN MODO "CAMCORDER"
    initCamcorderMode();

    async function initCamcorderMode() {
        // Limpieza previa
        if(globalStream) globalStream.getTracks().forEach(t => t.stop());
        if(audioContext) audioContext.close();

        try {
            status.innerText = "Activando modo videoc√°mara...";
            
            // PEDIMOS VIDEO Y AUDIO
            // Esto fuerza al OS a usar perfiles de grabaci√≥n de medios (Micro Externo habilitado)
            const constraints = {
                video: { 
                    facingMode: "environment",
                    width: { ideal: 640 }, // Resoluci√≥n baja para ahorrar bater√≠a
                    height: { ideal: 480 }
                },
                audio: {
                    echoCancellation: false, // Vital: Apagar cancelaci√≥n de eco
                    noiseSuppression: false,
                    autoGainControl: false
                }
            };

            globalStream = await navigator.mediaDevices.getUserMedia(constraints);
            
            // Conectamos el stream al video invisible (para enga√±ar al OS)
            dummyVideo.srcObject = globalStream;
            dummyVideo.play().catch(e=>{});

            // Iniciamos visualizador solo con la pista de audio
            startVisualizer(globalStream);
            status.innerText = "Modo Externo Activo. (Video Oculto)";

        } catch (e) {
            status.innerText = "Error: " + e.message;
            alert("Error: No se pudo activar la c√°mara/micr√≥fono. Revisa permisos.");
        }
    }

    function startVisualizer(stream) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        // Extraer solo audio del stream combinado
        microphone = audioContext.createMediaStreamSource(stream);
        jsNode = audioContext.createScriptProcessor(2048, 1, 1);
        
        monitorNode = audioContext.createGain();
        monitorNode.gain.value = 0;

        analyser.smoothingTimeConstant = 0.3; analyser.fftSize = 1024;

        microphone.connect(analyser);
        microphone.connect(monitorNode); monitorNode.connect(audioContext.destination);
        analyser.connect(jsNode); jsNode.connect(audioContext.destination);

        jsNode.onaudioprocess = () => {
            const array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(array);
            let values = 0; for (let i = 0; i < array.length; i++) values += array[i];
            const average = values / array.length;
            vuBar.style.width = Math.min(100, average * 3) + "%";
        };
    }

    function toggleMonitor() {
        isMonitoring = !isMonitoring;
        if(isMonitoring) { monitorNode.gain.value = 1; alert("üîä MONITOR ON"); } 
        else { monitorNode.gain.value = 0; }
    }

    // --- CONEXI√ìN ---
    btn.addEventListener('click', () => {
        if(isConnected) disconnect();
        else if(isScanning) stopScanner();
        else startScanner();
    });

    function startScanner() {
        isScanning = true; qrContainer.style.display = 'block'; btnText.innerText = "CANCELAR";
        html5QrCode = new Html5Qrcode("qr-reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decodedText) => { stopScanner(); connectToMixer(decodedText); },
            (err) => {}
        ).catch(err => {
            alert("C√°mara ocupada por el modo audio. Usa ID manual.");
            stopScanner(); document.getElementById('manual-area').style.display = 'flex';
        });
    }

    function stopScanner() {
        isScanning = false;
        if(html5QrCode) html5QrCode.stop().then(() => { qrContainer.style.display = 'none'; html5QrCode.clear(); }).catch(e=>{ qrContainer.style.display = 'none'; });
        btnText.innerText = "ESCANEAR ENLACE";
    }

    function manualConnect() {
        const id = document.getElementById('manual-id').value.trim();
        if(id) connectToMixer(id);
    }

    function connectToMixer(mixerId) {
        status.innerText = "Enviando se√±al...";
        status.style.color = "yellow";

        document.getElementById('fake-audio').play().catch(e=>{});
        if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(e=>{});

        // TRUCO FINAL: Crear un nuevo stream SOLO DE AUDIO a partir del stream de video
        // Esto es para no mandar video pesado por la red, solo el audio limpio
        const audioTrack = globalStream.getAudioTracks()[0];
        const transmissionStream = new MediaStream([audioTrack]);

        currentCall = peer.call(mixerId, transmissionStream);
        
        setConnectedState(true);
        status.innerText = "üî¥ EN AIRE";

        currentCall.on('close', () => disconnect());
        currentCall.on('error', (e) => { alert("Error: "+e); disconnect(); });
    }

    function setConnectedState(connected) {
        isConnected = connected;
        if(connected) {
            btn.classList.add('live'); btn.innerHTML = "üõë DETENER"; status.style.color = "#ff0000";
            document.getElementById('manual-area').style.display = 'none';
        } else {
            btn.classList.remove('live'); btn.innerHTML = "<span>üì°</span> <span id='btn-text'>ESCANEAR ENLACE</span>";
            status.innerText = "Listo"; status.style.color = "#aaa";
        }
    }

    function disconnect() {
        if(currentCall) currentCall.close();
        setConnectedState(false);
    }
</script>
</body>
</html>
