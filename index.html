<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>OBR LINK v4.0 APP</title>
    
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #00f3ff; --secondary: #ff0055; }
        body {
            background-color: #000;
            background-image: url('fondo_pantalla.jpg'); background-size: cover; background-position: center;
            color: var(--primary); font-family: 'Orbitron', sans-serif;
            overflow: hidden; height: 100dvh; width: 100vw; user-select: none;
        }
        body::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: -1; }
        
        .screen { position: fixed; inset: 0; z-index: 10; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; opacity: 0; transition: opacity 0.3s; }
        .screen.active { display: flex; opacity: 1; z-index: 20; }

        /* BOTONES APP */
        .app-btn {
            background: rgba(0, 0, 0, 0.6); border: 1px solid var(--primary); color: white;
            padding: 20px; border-radius: 15px; width: 100%; max-width: 350px;
            display: flex; align-items: center; gap: 15px; cursor: pointer;
            backdrop-filter: blur(10px); margin-bottom: 15px; transition: 0.2s;
        }
        .app-btn:active { transform: scale(0.98); background: var(--primary); color: black; }
        .app-btn.red { border-color: var(--secondary); }
        .app-btn.red:active { background: var(--secondary); color: white; }

        /* ESCANER */
        #scan-video { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; z-index: -1; }
        .scan-box { width: 250px; height: 250px; border: 4px solid var(--primary); box-shadow: 0 0 30px var(--primary); position: relative; }
        .scan-line { width: 100%; height: 2px; background: var(--secondary); position: absolute; animation: scan 2s infinite; }
        @keyframes scan { 0%{top:0} 50%{top:100%} 100%{top:0} }

        /* LIVE UI */
        .status-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); }
        .invoke-btn {
            width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--secondary);
            background: rgba(0,0,0,0.6); color: var(--secondary); font-size: 2.5rem;
            display: flex; align-items: center; justify-content: center; margin-bottom: 20px;
            box-shadow: 0 0 20px var(--secondary); transition: 0.3s;
        }
        .invoke-btn.listening { border-color: #00ff41; color: #00ff41; box-shadow: 0 0 40px #00ff41; transform: scale(1.1); }
        
        /* VIDEO OCULTO PERO ACTIVO */
        #keep-alive { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0.01; pointer-events: none; }
        /* CAMARA PREVIEW */
        #cam-preview { position: absolute; top: 80px; right: 20px; width: 100px; height: 140px; border: 1px solid #555; background: #000; object-fit: cover; opacity: 0.8; display: none; }
        #cam-preview.show { display: block; }

    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="s-login" class="screen active">
        <img src="obr-logo.png" class="w-32 mb-6 animate-pulse drop-shadow-[0_0_15px_rgba(0,243,255,0.5)]">
        <h1 class="text-3xl font-bold tracking-widest text-white mb-2">OBR LINK</h1>
        <p class="text-xs text-gray-400 font-mono mb-10">ACCESO REMOTO SEGURO</p>
        <button class="app-btn justify-center font-bold tracking-widest" onclick="startSystem()">INGRESAR</button>
        <p class="absolute bottom-6 text-[10px] text-gray-600">v4.0 APP MOBILE</p>
    </div>

    <!-- 2. SCANNER -->
    <div id="s-scan" class="screen">
        <video id="scan-video" playsinline muted></video>
        <div class="scan-box"><div class="scan-line"></div></div>
        <div class="absolute top-10 bg-black/80 px-6 py-2 rounded-full border border-cyan-500 text-cyan-400 text-sm font-bold tracking-widest">VINCULAR DETECTOR</div>
        <p class="absolute bottom-24 text-white text-xs text-center w-64 opacity-90 bg-black/60 p-2 rounded">Escanea el código QR del Detector para iniciar sesión.</p>
        <button onclick="location.reload()" class="absolute bottom-8 text-red-500 text-xs font-bold border-b border-red-500">CANCELAR</button>
    </div>

    <!-- 3. MENU -->
    <div id="s-menu" class="screen">
        <div class="text-center mb-8">
            <img src="obr-logo.png" class="w-20 mx-auto mb-2">
            <div class="text-xs text-green-400 border border-green-800 bg-green-900/30 px-3 py-1 rounded-full inline-block">Conectado</div>
        </div>

        <div class="app-btn" onclick="setMode('mic')">
            <i class="fas fa-microphone-lines text-2xl"></i>
            <div><div class="font-bold">MICRÓFONO PRO</div><div class="text-[10px] text-gray-300">Audio Alta Fidelidad</div></div>
        </div>

        <div class="app-btn red" onclick="setMode('spirit')">
            <i class="fas fa-ghost text-2xl text-red-500"></i>
            <div><div class="font-bold">SPIRIT BOX AI</div><div class="text-[10px] text-gray-300">EVP Contextual</div></div>
        </div>
        <div class="absolute bottom-6 text-[10px] text-gray-500">ID: <span id="host-id-disp">...</span></div>
    </div>

    <!-- 4. LIVE -->
    <div id="s-live" class="screen">
        <div class="status-bar">
            <div class="flex items-center gap-2"><div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div><span class="text-xs font-bold text-white">EN VIVO</span></div>
            <div id="mode-badge" class="text-[10px] border border-gray-600 px-2 py-1 rounded text-gray-400">MIC</div>
        </div>

        <video id="cam-preview" autoplay muted playsinline></video>

        <div class="flex-1 flex flex-col items-center justify-center w-full">
            <!-- Mic UI -->
            <div id="ui-mic" class="hidden"><div class="w-40 h-40 rounded-full border-2 border-cyan-500 flex items-center justify-center bg-cyan-500/10 shadow-[0_0_50px_rgba(0,243,255,0.3)]"><i class="fas fa-microphone text-6xl text-cyan-400"></i></div></div>
            
            <!-- Spirit UI -->
            <div id="ui-spirit" class="hidden flex-col items-center">
                <button id="invoke-btn" class="invoke-btn" onclick="startEVP()"><i class="fas fa-fingerprint"></i></button>
                <p id="invoke-lbl" class="text-xs text-gray-400 font-mono mb-4">TOCA PARA PREGUNTAR</p>
                <div id="spirit-txt" class="text-center text-red-500 font-mono text-lg min-h-[60px] px-4">...</div>
            </div>
        </div>

        <button onclick="logout()" class="w-full py-4 bg-red-900/40 text-red-400 font-bold text-sm rounded-xl border border-red-900/50 mb-4">CERRAR SESIÓN</button>
        
        <!-- Hidden Engines -->
        <video id="keep-alive" playsinline autoplay muted loop></video>
        <audio id="bg-noise" src="FONDO_1.mp3" loop></audio>
    </div>

<script>
    const GEMINI = "AIzaSyDbFXVNT5jyZZclbOexvgkB_FK8ijC5qU4";
    let stream, peer, conn, hostId, audioCtx, micNode, destNode;
    let recognition, isProcessing=false;

    async function startSystem() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ audio: {echoCancellation:true, noiseSuppression:true}, video: {facingMode:"environment", width:{ideal:640}} });
            document.getElementById('keep-alive').srcObject = stream;
            document.getElementById('scan-video').srcObject = stream;
            document.getElementById('cam-preview').srcObject = stream;
            document.getElementById('scan-video').play();
            show('s-scan'); scanQR();
        } catch(e) { alert("Error: " + e.message); }
    }

    function scanQR() {
        const v = document.getElementById('scan-video');
        const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
        function loop() {
            if(v.readyState===4) {
                cvs.width=v.videoWidth; cvs.height=v.videoHeight; ctx.drawImage(v,0,0);
                const c = jsQR(ctx.getImageData(0,0,cvs.width,cvs.height).data, cvs.width, cvs.height);
                if(c) { link(c.data); return; }
            }
            if(document.getElementById('s-scan').style.display === 'flex') requestAnimationFrame(loop);
        } loop();
    }

    function link(id) {
        hostId = id; document.getElementById('host-id-disp').innerText = id;
        peer = new Peer();
        peer.on('open', () => show('s-menu'));
        peer.on('error', () => { alert("Error Conexion"); location.reload(); });
        setTimeout(logout, 36000000); // 10 Horas
    }

    function setMode(m) {
        document.getElementById('mode-badge').innerText = m==='mic' ? 'MIC PRO' : 'SPIRIT AI';
        document.getElementById('ui-mic').className = m==='mic' ? 'block' : 'hidden';
        document.getElementById('ui-spirit').className = m==='spirit' ? 'flex flex-col items-center' : 'hidden';
        document.getElementById('cam-preview').className = m==='spirit' ? 'show' : '';
        
        const bg = document.getElementById('bg-noise');
        if(m==='spirit') { initSpeech(); bg.volume=0.3; bg.play().catch(()=>{}); } else bg.pause();
        
        initAudio();
        show('s-live');
    }

    function initAudio() {
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        destNode = audioCtx.createMediaStreamDestination();
        micNode = audioCtx.createMediaStreamSource(stream);
        micNode.connect(destNode);
        
        const callStream = destNode.stream;
        if(stream.getVideoTracks().length>0) callStream.addTrack(stream.getVideoTracks()[0].clone());
        
        peer.call(hostId, callStream);
        conn = peer.connect(hostId);
        conn.on('close', ()=>logout());
    }

    function initSpeech() {
        if('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'es-ES'; recognition.continuous = false;
            recognition.onresult = e => askAI(e.results[0][0].transcript);
            recognition.onerror = () => askAI("");
        }
    }

    function startEVP() {
        if(isProcessing) return;
        const btn = document.getElementById('invoke-btn');
        document.getElementById('bg-noise').volume = 0.1;
        if(recognition) {
            btn.classList.add('listening');
            btn.innerHTML = '<i class="fas fa-microphone"></i>';
            document.getElementById('invoke-lbl').innerText = "ESCUCHANDO...";
            recognition.start();
        } else askAI("");
    }

    async function askAI(q) {
        const btn = document.getElementById('invoke-btn');
        btn.classList.remove('listening'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        document.getElementById('invoke-lbl').innerText = "CONTACTANDO...";
        
        try {
            const cvs = document.createElement('canvas'); cvs.width=640; cvs.height=480;
            cvs.getContext('2d').drawImage(document.getElementById('keep-alive'),0,0);
            const b64 = cvs.toDataURL('image/jpeg', 0.5).split(',')[1];
            
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({contents:[{parts:[{text:`Rol: Espíritu. Pregunta: "${q}". Responde corto y tétrico según lo que ves.`},{inline_data:{mime_type:"image/jpeg",data:b64}}]}]})
            });
            const d = await r.json();
            const txt = d.candidates?.[0]?.content?.parts?.[0]?.text || "...";
            
            document.getElementById('spirit-txt').innerText = txt.toUpperCase();
            if('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(txt);
                u.lang = 'es-ES'; u.pitch = 0.6; u.rate = 0.85;
                window.speechSynthesis.speak(u);
            }
        } catch(e) {}
        
        btn.innerHTML = '<i class="fas fa-fingerprint"></i>';
        document.getElementById('invoke-lbl').innerText = "LISTO";
        document.getElementById('bg-noise').volume = 0.3;
        isProcessing = false;
    }

    function show(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function logout() { if(peer) peer.destroy(); location.reload(); }

</script>
</body>
</html>
